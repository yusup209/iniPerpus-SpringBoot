<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Presence - iniPerpus</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="navbar">
    <a href="/" class="navbar-brand">ðŸ“š iniPerpus</a>
    <div class="navbar-links">
      <a href="/" class="nav-link">Home</a>
      <a href="/books" class="nav-link">Books</a>
      <a href="/lending" class="nav-link">Lending</a>
      <a href="/users" class="nav-link">Students</a>
      <a href="#" class="nav-link" onclick="appLogout(event)">Logout</a>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>ðŸ“¸ Student Presence</h1>
      <p style="color:#4b5563; margin-top:8px;">Use the camera to register student faces and check them in via the python-face-service.</p>
    </div>
    
    <div class="grid">
      <div class="card" style="text-align: center;">
        <h2 style="margin-bottom: 20px;">Camera</h2>
        
        <div style="position: relative; display: inline-block; margin: 20px; max-width: 90%; width: 100%;">
          <video id="video" autoplay style="border-radius: 12px; background: #000; display: block; width: 100%; max-width: 800px; height: auto; margin: 0 auto;"></video>
          <canvas id="canvas" style="display: none;"></canvas>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 12px;">
          <button id="startCameraBtn" onclick="toggleCamera()">Start Camera</button>
          <button id="checkInBtn" onclick="checkIn()" disabled>Check In</button>
          <button id="registerBtn" onclick="registerFace()" disabled>Register Face</button>
        </div>
        
        <div style="display:flex; gap:12px; justify-content:center; align-items:center; margin-bottom:12px;">
          <label for="studentSelect" style="font-weight:600; color:#374151;">Link to Student:</label>
          <select id="studentSelect" style="min-width:220px; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;">
            <option value="">-- Select student --</option>
            <option th:each="s : ${students}" th:value="${s.id}" th:text="${s.name + ' (' + s.studentId + ')'}" th:attr="data-sid=${s.studentId}"></option>
          </select>
        </div>

        <div id="result" style="padding: 20px; border-radius: 12px; margin-top: 10px; display: none;"></div>
        <div id="enrollResult" style="padding: 16px; border-radius: 12px; margin-top: 10px; display: none;"></div>
      </div>

      <div class="card">
        <h2 style="margin-bottom: 20px;">Recent Check-Ins</h2>
        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Total Check-Ins: <span id="totalPresence" style="font-weight: 600; color: #374151;">0</span></p>
        <div style="overflow-x: auto;">
          <table id="presenceTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Student ID</th>
                <th>Name</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="presenceBody"></tbody>
          </table>
        </div>
        <div id="presencePagination" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
  </form>

  <script>
    let stream = null;
    let presenceRecords = [];
    const pagingPresence = { page: 1, size: 5 };
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startCameraBtn');
    const checkInBtn = document.getElementById('checkInBtn');
    const registerBtn = document.getElementById('registerBtn');
    const resultDiv = document.getElementById('result');
    const enrollResultDiv = document.getElementById('enrollResult');
    const studentSelect = document.getElementById('studentSelect');

    // Pagination helper
    function ensureValidPagePresence(total) {
      const maxPages = Math.max(1, Math.ceil(total / pagingPresence.size));
      if (pagingPresence.page > maxPages) pagingPresence.page = maxPages;
      if (pagingPresence.page < 1) pagingPresence.page = 1;
      return maxPages;
    }

    function renderPaginationPresence(total) {
      const el = document.getElementById('presencePagination');
      if (!el) return;
      const maxPages = Math.max(1, Math.ceil(total / pagingPresence.size));
      el.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;">
          <select onchange="setPageSizePresence(this.value)" style="padding:8px 10px;border-radius:8px;border:1px solid #d1d5db;">
            <option value="5" ${pagingPresence.size==5?'selected':''}>5</option>
            <option value="10" ${pagingPresence.size==10?'selected':''}>10</option>
            <option value="25" ${pagingPresence.size==25?'selected':''}>25</option>
          </select>
          <span>Page ${pagingPresence.page} / ${maxPages}</span>
          <button onclick="changePagePresence(-1)">Prev</button>
          <button onclick="changePagePresence(1)">Next</button>
        </div>`;
    }

    function changePagePresence(delta) {
      const max = ensureValidPagePresence(presenceRecords.length);
      pagingPresence.page = Math.min(max, Math.max(1, pagingPresence.page + delta));
      renderPresenceRecords(presenceRecords);
    }

    function setPageSizePresence(size) {
      pagingPresence.size = parseInt(size);
      pagingPresence.page = 1;
      renderPresenceRecords(presenceRecords);
    }

    // Fetch and render presence records
    async function fetchPresenceRecords() {
      try {
        const response = await fetch('/api/presence/records');
        const records = await response.json();
        presenceRecords = records;
        renderPresenceRecords(records);
      } catch (err) {
        console.error('Failed to fetch presence records:', err);
      }
    }

    function renderPresenceRecords(records) {
      const tbody = document.getElementById('presenceBody');
      const totalEl = document.getElementById('totalPresence');
      if (totalEl) totalEl.textContent = records ? records.length : 0;
      if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#9ca3af;">No check-ins yet</td></tr>';
        document.getElementById('presencePagination').innerHTML = '';
        return;
      }
      const maxPages = ensureValidPagePresence(records.length);
      const start = (pagingPresence.page - 1) * pagingPresence.size;
      const pageRows = records.slice(start, start + pagingPresence.size);
      tbody.innerHTML = pageRows.map(r => {
        const time = new Date(r.timestamp).toLocaleString();
        const studentId = r.student ? r.student.studentId : 'â€”';
        const name = r.student ? r.student.name : 'â€”';
        const status = r.matched ? '<span style="color:#10b981;">âœ“ Matched</span>' : '<span style="color:#ef4444;">âœ— Not matched</span>';
        return `
          <tr>
            <td>${time}</td>
            <td>${studentId}</td>
            <td>${name}</td>
            <td>${status}</td>
          </tr>
        `;
      }).join('');
      renderPaginationPresence(records.length);
    }

    function setStatus(el, html, background) {
      el.style.display = 'block';
      el.innerHTML = html;
      el.style.background = background;
    }

    async function toggleCamera() {
      if (stream) {
        // Stop camera
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        video.srcObject = null;
        startBtn.disabled = false;
        startBtn.textContent = 'Start Camera';
        checkInBtn.disabled = true;
        registerBtn.disabled = true;
        resultDiv.style.display = 'none';
        enrollResultDiv.style.display = 'none';
      } else {
        // Start camera
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          startBtn.textContent = 'Stop Camera';
          checkInBtn.disabled = false;
          registerBtn.disabled = false;
          resultDiv.style.display = 'none';
          enrollResultDiv.style.display = 'none';
        } catch (err) {
          alert('Failed to access camera: ' + err.message);
        }
      }
    }

    async function checkIn() {
      const width = video.videoWidth;
      const height = video.videoHeight;
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');

        setStatus(resultDiv, '<p style="color: #667eea;">Processing check-in...</p>', 'transparent');

        try {
          const response = await fetch('/api/presence/checkin', { method: 'POST', body: formData });
          const result = await response.json();

          if (result.matched) {
            setStatus(resultDiv, `
              <p style="color: #10b981; font-size: 1.2em; font-weight: 600;">âœ“ Check-In Successful!</p>
              <p style="color: #333; margin-top: 10px;">Welcome, ${result.student_id || 'Student'}</p>
            `, 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)');
            fetchPresenceRecords();
          } else {
            setStatus(resultDiv, `
              <p style="color: #ef4444; font-size: 1.2em; font-weight: 600;">âœ— Face Not Recognized</p>
              <p style="color: #666; margin-top: 10px;">Please try again or contact administrator</p>
            `, 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)');
          }
        } catch (err) {
          setStatus(resultDiv, `<p style="color: #ef4444;">Error: ${err.message}</p>`, 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)');
        }
      }, 'image/jpeg');
    }

    async function registerFace() {
      const studentId = studentSelect.value;
      if (!studentId) {
        alert('Please select a student to register.');
        return;
      }
      const width = video.videoWidth;
      const height = video.videoHeight;
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(video, 0, 0, width, height);
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');
        formData.append('studentId', studentId);

        setStatus(enrollResultDiv, '<p style="color: #667eea;">Registering face...</p>', 'transparent');

        try {
          const response = await fetch('/api/presence/enroll', { method: 'POST', body: formData });
          const result = await response.json();
          if (response.ok) {
            setStatus(enrollResultDiv, `
              <p style="color: #2563eb; font-size: 1.1em; font-weight: 600;">âœ“ Face Registered</p>
              <p style="color: #374151; margin-top: 8px;">Linked to student ${result.student_id || ''}</p>
            `, 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)');
          } else {
            setStatus(enrollResultDiv, `<p style="color: #ef4444;">Failed: ${result.error || 'Unknown error'}</p>`, 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)');
          }
        } catch (err) {
          setStatus(enrollResultDiv, `<p style="color: #ef4444;">Error: ${err.message}</p>`, 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)');
        }
      }, 'image/jpeg');
    }

    function appLogout(e) {
      e.preventDefault();
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      document.getElementById('logoutConfirmModal').style.display = 'block';
    }

    function confirmLogout() {
      try { sessionStorage.removeItem('isLoggedIn'); } catch (err) {}
      document.getElementById('logoutForm').submit();
    }

    function cancelLogout() {
      document.getElementById('logoutConfirmModal').style.display = 'none';
    }

    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    });

    // Load presence records on page load
    fetchPresenceRecords();
  </script>

  <!-- Logout Confirmation Modal -->
  <div id="logoutConfirmModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:32px; border-radius:12px; width:90%; max-width:500px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <h2 style="color:#333; margin-bottom:16px;">Confirm Logout</h2>
      <p style="color:#666; margin-bottom:24px; font-size:16px;">Are you sure you want to logout?</p>
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button type="button" class="btn-cancel" onclick="cancelLogout()">Cancel</button>
        <button type="button" class="btn-delete-confirm" onclick="confirmLogout()">Yes, Logout</button>
      </div>
    </div>
  </div>

</body>
</html>
